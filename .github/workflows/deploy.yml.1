name: Deploy

# Trigger the workflow on push and
# pull request events on the production branch

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

# Authenticate to the the server via ssh
# and run our deployment script
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Compile CSS and Java
        run: |
          npm install
          npm run build

      - name: Configure PHP8
        uses: shivammathur/setup-php@master
        with:
          php-version: 8.0
          extensions: mbstring, ctype, fileinfo, openssl, PDO, bcmath, json, tokenizer, xml
      - name: Enter maintenance mode or return true
              # if already is in maintenance mode
        run: (php artisan down) || true

      - name: Pull the latest version of the app
        run: git pull origin develop

      - name: Clear the old cache
        run: php artisan clear-compiled

      - name: Recreate cache
        run: php artisan optimize

      - name: Run database migrations
        run: php artisan migrate --force

      - name: Exit maintenance mode
        run: php artisan up

      - name: Install composer dependencies
        run: composer install --ignore-platform-reqs --no-dev --no-interaction --prefer-dist --optimize-autoloader
